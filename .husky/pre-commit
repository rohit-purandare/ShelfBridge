#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ”’ Running pre-commit checks..."

# Run ESLint on staged JavaScript files in src/ directory
echo "ğŸ” Running ESLint..."
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^src/.*\.js$' || true)
if [ -n "$STAGED_JS_FILES" ]; then
    echo "Checking staged JavaScript files..."
    echo "$STAGED_JS_FILES" | xargs npx eslint --max-warnings 0 || {
        echo ""
        echo "âŒ ESLint found issues!"
        echo "ğŸ’¡ Fix the linting errors above before committing"
        echo "ğŸ’¡ Run 'npx eslint src/ --ext .js --max-warnings 0' to check all files"
        exit 1
    }
    echo "âœ… ESLint passed"
else
    echo "No JavaScript files staged in src/, skipping ESLint"
fi

# Run gitleaks to scan for secrets
echo "Scanning for secrets with gitleaks..."
if ! gitleaks detect --verbose; then
    echo ""
    echo "âŒ Gitleaks found potential secrets!"
    echo "ğŸ’¡ If these are false positives, add them to .gitleaks.toml allowlist"
    echo "ğŸ’¡ If these are real secrets, remove them and use environment variables instead"
    echo "ğŸ’¡ Run 'gitleaks detect --verbose' to see details"
    exit 1
else
    echo "âœ… No secrets found"
fi

# Run npm audit if package.json is staged
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if echo "$STAGED_FILES" | grep -q "package.json\|package-lock.json"; then
    echo "Running npm audit..."
    npm audit --audit-level=moderate || {
        echo "âš ï¸  npm audit found vulnerabilities. Consider updating dependencies."
        echo "ğŸ’¡ Run 'npm audit fix' to automatically fix some issues"
        # Don't fail the commit for audit issues, just warn
    }
fi

echo "ğŸ”’ Pre-commit checks completed" 