#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔒 Running pre-commit checks..."

# Run ESLint on staged JavaScript files in src/ directory
echo "🔍 Running ESLint..."
STAGED_JS_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^src/.*\.js$' || true)
if [ -n "$STAGED_JS_FILES" ]; then
    echo "Checking staged JavaScript files..."
    echo "$STAGED_JS_FILES" | xargs npx eslint --max-warnings 0 || {
        echo ""
        echo "❌ ESLint found issues!"
        echo "💡 Fix the linting errors above before committing"
        echo "💡 Run 'npx eslint src/ --ext .js --max-warnings 0' to check all files"
        exit 1
    }
    echo "✅ ESLint passed"
else
    echo "No JavaScript files staged in src/, skipping ESLint"
fi

# Run gitleaks to scan for secrets
echo "Scanning for secrets with gitleaks..."
if ! gitleaks detect --verbose; then
    echo ""
    echo "❌ Gitleaks found potential secrets!"
    echo "💡 If these are false positives, add them to .gitleaks.toml allowlist"
    echo "💡 If these are real secrets, remove them and use environment variables instead"
    echo "💡 Run 'gitleaks detect --verbose' to see details"
    exit 1
else
    echo "✅ No secrets found"
fi

# Run npm audit if package.json is staged
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if echo "$STAGED_FILES" | grep -q "package.json\|package-lock.json"; then
    echo "Running npm audit..."
    npm audit --audit-level=moderate || {
        echo "⚠️  npm audit found vulnerabilities. Consider updating dependencies."
        echo "💡 Run 'npm audit fix' to automatically fix some issues"
        # Don't fail the commit for audit issues, just warn
    }
fi

echo "🔒 Pre-commit checks completed" 