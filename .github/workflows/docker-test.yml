name: Docker Test

on:
  workflow_run:
    workflows: ['Docker Build']
    types: [completed]
    branches:
      [
        main,
        'feature/*',
        'feat/*',
        'bugfix/*',
        'fix/*',
        'hotfix/*',
        'release/*',
        'ci/*',
      ]
  pull_request:
    branches: [main]
  workflow_call:
    inputs:
      image-tags:
        description: 'Docker image tags to test'
        required: true
        type: string

env:
  REGISTRY: ghcr.io

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: read
    # Only run if the Docker Build workflow succeeded, or this is a PR, or workflow_call
    if: ${{ github.event_name == 'pull_request' || github.event_name == 'workflow_call' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine image tag to test (workflow_run)
        if: github.event_name == 'workflow_run'
        id: set-image-tag
        run: |
          echo "ğŸ” Determining image tag to test from workflow_run..."

          # Lowercase repository for GHCR compatibility
          LOWER_REPO=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')

          # Use the head SHA from the triggering build (short 7 chars)
          SHORT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)

          IMAGE_TAG="ghcr.io/${LOWER_REPO}:sha-${SHORT_SHA}"
          echo "Testing image: ${IMAGE_TAG}"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV

      - name: Build image for PR testing
        if: github.event_name == 'pull_request'
        run: |
          echo "ğŸ”¨ Building Docker image for PR testing..."

          # Build image locally for testing
          docker build -t test-image:pr .
          echo "IMAGE_TAG=test-image:pr" >> $GITHUB_ENV
          echo "Built image for PR testing: test-image:pr"

      - name: Set image tag for workflow_call
        if: github.event_name == 'workflow_call'
        run: |
          # For workflow_call, use the provided tags
          TAG=$(echo "${{ inputs.image-tags }}" | head -n1)
          echo "Testing image: $TAG"
          echo "IMAGE_TAG=$TAG" >> $GITHUB_ENV

      - name: Test Docker image native modules (CRITICAL)
        run: |
          echo "ğŸ§ª CRITICAL: Testing Docker image native modules compatibility..."
          echo "âš ï¸  BUILD WILL FAIL if native modules don't work - blocking push"
          echo "Testing image: $IMAGE_TAG"

          # Test native modules in the container - this MUST succeed or build fails
          if docker run --rm \
            -e SHELFBRIDGE_USER_0_ID=${{ secrets.TEST_USER_ID || 'test_user' }} \
            -e SHELFBRIDGE_USER_0_ABS_URL=${{ secrets.TEST_ABS_URL || 'https://test.audiobookshelf.com' }} \
            -e SHELFBRIDGE_USER_0_ABS_TOKEN=${{ secrets.TEST_ABS_TOKEN || 'test_abs_token_1234567890' }} \
            -e SHELFBRIDGE_USER_0_HARDCOVER_TOKEN=${{ secrets.TEST_HARDCOVER_TOKEN || 'test_hc_token_1234567890' }} \
            --entrypoint="" \
            $IMAGE_TAG \
            npm run test:native; then
            echo "âœ… Docker image native modules test passed - proceeding with database tests"
          else
            echo "âŒ CRITICAL FAILURE: Native modules are broken in Docker image"
            echo "ğŸš« BLOCKING DEPLOYMENT - Fix required before merge/release"
            echo "ğŸš« IMAGE WILL NOT BE PUSHED TO REGISTRY"
            exit 1
          fi

      - name: Test Docker image better-sqlite3 functionality (CRITICAL)
        run: |
          echo "ğŸ§ª CRITICAL: Testing better-sqlite3 database operations in Docker..."
          echo "âš ï¸  This test would have caught the GLIBC issue"
          echo "Testing database operations in image: $IMAGE_TAG"

          # Test comprehensive better-sqlite3 functionality
          if docker run --rm --entrypoint="" $IMAGE_TAG node -e "
            console.log('ğŸ” Testing better-sqlite3 comprehensive functionality...');
            const db = require('better-sqlite3')(':memory:');
            
            // Test 1: Table creation
            db.exec('CREATE TABLE test_table (id INTEGER PRIMARY KEY, name TEXT, value REAL)');
            console.log('âœ… Table creation successful');
            
            // Test 2: Insert operations
            const insert = db.prepare('INSERT INTO test_table (name, value) VALUES (?, ?)');
            insert.run('test1', 123.45);
            insert.run('test2', 678.90);
            console.log('âœ… Insert operations successful');
            
            // Test 3: Query operations
            const rows = db.prepare('SELECT * FROM test_table ORDER BY id').all();
            if (rows.length !== 2 || rows[0].name !== 'test1') {
              throw new Error('Query verification failed');
            }
            console.log('âœ… Query operations successful');
            
            // Test 4: Transaction support
            const transaction = db.transaction(() => {
              insert.run('test3', 999.99);
              insert.run('test4', 111.11);
            });
            transaction();
            const count = db.prepare('SELECT COUNT(*) as count FROM test_table').get().count;
            if (count !== 4) {
              throw new Error('Transaction test failed');
            }
            console.log('âœ… Transaction support successful');
            
            // Test 5: File database operations
            const fileDb = require('better-sqlite3')('/tmp/test-file.db');
            fileDb.exec('CREATE TABLE file_test (id INTEGER)');
            fileDb.exec('INSERT INTO file_test (id) VALUES (1)');
            const fileCount = fileDb.prepare('SELECT COUNT(*) as count FROM file_test').get().count;
            fileDb.close();
            if (fileCount !== 1) {
              throw new Error('File database test failed');
            }
            console.log('âœ… File database operations successful');
            
            db.close();
            console.log('ğŸ‰ ALL better-sqlite3 tests passed - database is fully functional!');
          "; then
            echo "âœ… better-sqlite3 comprehensive testing passed"
          else
            echo "âŒ CRITICAL FAILURE: better-sqlite3 database operations failed"
            echo "ğŸš¨ This indicates a GLIBC, musl, or native module compilation issue"
            echo "ğŸš« BLOCKING DEPLOYMENT - Database functionality is broken"
            exit 1
          fi

      - name: Test Docker image application startup (CRITICAL)
        run: |
          echo "ğŸ§ª CRITICAL: Testing full application startup in Docker..."
          echo "âš ï¸  Verifying ShelfBridge can initialize without crashes"
          echo "Testing application startup in image: $IMAGE_TAG"

          # Test application version and help commands
          if docker run --rm --entrypoint="" $IMAGE_TAG node src/main.js --version; then
            echo "âœ… Application version command passed"
          else
            echo "âŒ CRITICAL FAILURE: Application version command failed"
            echo "ğŸš« BLOCKING DEPLOYMENT - Basic app functionality broken"
            exit 1
          fi

          if docker run --rm --entrypoint="" $IMAGE_TAG node src/main.js --help >/dev/null 2>&1; then
            echo "âœ… Application help command passed"
          else
            echo "âŒ CRITICAL FAILURE: Application help command failed"
            echo "ğŸš« BLOCKING DEPLOYMENT - Basic app functionality broken"
            exit 1
          fi

          echo "âœ… Application startup tests passed"

      - name: Test Docker image configuration validation (CRITICAL)
        run: |
          echo "ğŸ§ª CRITICAL: Testing configuration validation in Docker..."
          echo "âš ï¸  Ensuring config system works with database"
          echo "Testing configuration in image: $IMAGE_TAG"

          # Test configuration validation with environment variables
          if docker run --rm \
            -e SHELFBRIDGE_USER_0_ID=${{ secrets.TEST_USER_ID || 'test_user' }} \
            -e SHELFBRIDGE_USER_0_ABS_URL=${{ secrets.TEST_ABS_URL || 'https://test.audiobookshelf.com' }} \
            -e SHELFBRIDGE_USER_0_ABS_TOKEN=${{ secrets.TEST_ABS_TOKEN || 'test_abs_token_1234567890' }} \
            -e SHELFBRIDGE_USER_0_HARDCOVER_TOKEN=${{ secrets.TEST_HARDCOVER_TOKEN || 'test_hc_token_1234567890' }} \
            --entrypoint="" \
            $IMAGE_TAG \
            node src/main.js validate >/dev/null 2>&1; then
            echo "âœ… Configuration validation tests passed"
          else
            echo "âŒ CRITICAL FAILURE: Configuration validation failed"
            echo "ğŸš« BLOCKING DEPLOYMENT - Config system broken"
            exit 1
          fi

      - name: Test Docker image health check (CRITICAL)
        run: |
          echo "ğŸ§ª CRITICAL: Testing Docker health check functionality..."
          echo "âš ï¸  Verifying built-in health checks work correctly"
          echo "Testing health check in image: $IMAGE_TAG"

          # Test the health check command that's defined in Dockerfile
          if docker run --rm --entrypoint="" $IMAGE_TAG node -e "
            try {
              const db = require('better-sqlite3')(':memory:');
              db.exec('CREATE TABLE health_check (id INTEGER PRIMARY KEY, timestamp TEXT)');
              const stmt = db.prepare('INSERT INTO health_check (timestamp) VALUES (?)');
              stmt.run(new Date().toISOString());
              const count = db.prepare('SELECT COUNT(*) as count FROM health_check').get().count;
              if (count !== 1) throw new Error('Health check failed');
              db.close();
              console.log('âœ… Health check passed');
            } catch (e) {
              console.error('âŒ Health check failed:', e.message);
              process.exit(1);
            }
          "; then
            echo "âœ… Health check functionality verified"
          else
            echo "âŒ CRITICAL FAILURE: Health check is broken"
            echo "ğŸš« BLOCKING DEPLOYMENT - Health monitoring will fail"
            exit 1
          fi

      - name: Test Docker image cache functionality (CRITICAL)
        run: |
          echo "ğŸ§ª CRITICAL: Testing cache/database functionality in Docker..."
          echo "âš ï¸  Verifying BookCache can initialize and operate"
          echo "Testing cache functionality in image: $IMAGE_TAG"

          # Test cache functionality with proper environment
          if docker run --rm \
            -e SHELFBRIDGE_USER_0_ID=${{ secrets.TEST_USER_ID || 'test_user' }} \
            -e SHELFBRIDGE_USER_0_ABS_URL=${{ secrets.TEST_ABS_URL || 'https://test.audiobookshelf.com' }} \
            -e SHELFBRIDGE_USER_0_ABS_TOKEN=${{ secrets.TEST_ABS_TOKEN || 'test_abs_token_1234567890' }} \
            -e SHELFBRIDGE_USER_0_HARDCOVER_TOKEN=${{ secrets.TEST_HARDCOVER_TOKEN || 'test_hc_token_1234567890' }} \
            --entrypoint="" \
            $IMAGE_TAG \
            npm run cache -- --show >/dev/null 2>&1; then
            echo "âœ… Cache functionality tests passed"
          else
            echo "âŒ CRITICAL FAILURE: Cache functionality is broken"
            echo "ğŸš« BLOCKING DEPLOYMENT - Database operations will fail"
            exit 1
          fi

      - name: Comprehensive Docker image validation summary
        run: |
          echo "ğŸ‰ ALL CRITICAL DOCKER TESTS PASSED!"
          echo ""
          echo "âœ… Tests completed successfully:"
          echo "  â€¢ Native modules compatibility"
          echo "  â€¢ better-sqlite3 database operations (GLIBC/musl compatibility)"
          echo "  â€¢ Application startup and basic functionality"
          echo "  â€¢ Configuration validation and environment handling"
          echo "  â€¢ Health check functionality"
          echo "  â€¢ Cache/database initialization and operations"
          echo ""
          echo "ğŸš€ Docker image is verified and ready for deployment"
          echo "ğŸ”’ These tests prevent broken releases like GLIBC compatibility issues"
