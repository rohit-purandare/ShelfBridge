name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [20.x, 22.x]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run application tests (CRITICAL)
        env:
          # Test environment variables for configuration validation
          SHELFBRIDGE_USER_0_ID: 'test_user'
          SHELFBRIDGE_USER_0_ABS_URL: 'https://test.audiobookshelf.com'
          SHELFBRIDGE_USER_0_ABS_TOKEN: 'test_abs_token_1234567890'
          SHELFBRIDGE_USER_0_HARDCOVER_TOKEN: 'test_hc_token_1234567890'
        run: |
          echo "ğŸ§ª CRITICAL: Running application tests on Node ${{ matrix.node-version }}"
          echo "âš ï¸  BUILD WILL FAIL if tests don't pass"
          if ! npm test; then
            echo "âŒ CRITICAL FAILURE: Application tests failed on Node ${{ matrix.node-version }}"
            echo "ğŸš« BLOCKING BUILD - Fix required before merge"
            exit 1
          fi
          echo "âœ… Application tests passed on Node ${{ matrix.node-version }}"

      - name: Test native modules compatibility (CRITICAL)
        run: |
          echo "ğŸ§ª CRITICAL: Testing native modules compatibility on Node ${{ matrix.node-version }}"
          echo "âš ï¸  BUILD WILL FAIL if native modules don't work"
          if ! npm run test:native; then
            echo "âŒ CRITICAL FAILURE: Native modules broken on Node ${{ matrix.node-version }}"
            echo "ğŸš« BLOCKING BUILD - Fix required before merge"
            exit 1
          fi
          echo "âœ… Native modules compatible with Node ${{ matrix.node-version }}"

      - name: Test cache functionality (CRITICAL)
        env:
          # Test environment variables for cache tests
          SHELFBRIDGE_USER_0_ID: 'test_user'
          SHELFBRIDGE_USER_0_ABS_URL: 'https://test.audiobookshelf.com'
          SHELFBRIDGE_USER_0_ABS_TOKEN: 'test_abs_token_1234567890'
          SHELFBRIDGE_USER_0_HARDCOVER_TOKEN: 'test_hc_token_1234567890'
        run: |
          echo "ğŸ§ª CRITICAL: Testing cache functionality on Node ${{ matrix.node-version }}"
          echo "âš ï¸  BUILD WILL FAIL if cache doesn't work"
          if ! npm run cache -- --show; then
            echo "âŒ CRITICAL FAILURE: Cache functionality broken on Node ${{ matrix.node-version }}"
            echo "ğŸš« BLOCKING BUILD - Fix required before merge"
            exit 1
          fi
          echo "âœ… Cache functionality working on Node ${{ matrix.node-version }}"

      - name: Verify main entry point (CRITICAL)
        run: |
          echo "ğŸ§ª CRITICAL: Testing main entry point on Node ${{ matrix.node-version }}"
          echo "âš ï¸  BUILD WILL FAIL if main entry point doesn't work"
          if ! node src/main.js --help >/dev/null 2>&1; then
            echo "âŒ CRITICAL FAILURE: Main entry point broken on Node ${{ matrix.node-version }}"
            echo "ğŸš« BLOCKING BUILD - Fix required before merge"
            exit 1
          fi
          echo "âœ… Main entry point working on Node ${{ matrix.node-version }}"

      - name: Check for required files (CRITICAL)
        run: |
          echo "ğŸ§ª CRITICAL: Checking required files on Node ${{ matrix.node-version }}"
          echo "âš ï¸  BUILD WILL FAIL if required files are missing"
          if [ ! -f "config/config.yaml.example" ]; then
            echo "âŒ CRITICAL FAILURE: config/config.yaml.example not found"
            echo "ğŸš« BLOCKING BUILD - Fix required before merge"
            exit 1
          fi
          echo "âœ… Required files present on Node ${{ matrix.node-version }}"
